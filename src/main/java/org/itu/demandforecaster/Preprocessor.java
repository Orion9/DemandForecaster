package org.itu.demandforecaster;

import org.apache.spark.SparkConf;
import org.apache.spark.api.java.JavaSparkContext;
import org.apache.spark.ml.feature.OneHotEncoder;
import org.apache.spark.ml.feature.StringIndexer;
import org.apache.spark.ml.feature.VectorAssembler;
import org.apache.spark.sql.DataFrame;
import org.apache.spark.sql.SQLContext;

/**
 * Created by Group 1.
 */

public class Preprocessor {
    /**
     * Attributes
     */

    // DataFrames generated by data files.
    protected DataFrame trainingData;
    protected DataFrame testData;

    // Objects for data preprocessing.
    public StringIndexer categoryIndexer;
    public OneHotEncoder dayOfWeekEncoder, categoryEncoder;
    public VectorAssembler vectorAssembler;

    // Debugging purposes only.
    public DataFrame debug;

    /**
     * When a new object is derived, it sets up necessary indexers and encoders
     * according to the necessary columns. Basically, it extracts necessary
     * features for prediction model.
     */
    public Preprocessor(){
        categoryIndexer = new StringIndexer()
                .setInputCol("category")
                .setOutputCol("categoryIndex");

        dayOfWeekEncoder = new OneHotEncoder()
                .setInputCol("dayOfWeek")
                .setOutputCol("dayOfWeekVector");

        categoryEncoder = new OneHotEncoder()
                .setInputCol("categoryIndex")
                .setOutputCol("categoryVector");

        String[] cols = {"categoryVector", "dayOfWeekVector"};
        vectorAssembler = new VectorAssembler()
                .setInputCols(cols)
                .setOutputCol("features");
    }

    /**
     * Getters and setters.
     */

    public void loadTrainingData() {
        SparkConf sparkConf = Configuration.getSparkConfig().config;
        JavaSparkContext sparkContext = new JavaSparkContext(sparkConf);
        SQLContext sqlContext = new SQLContext(sparkContext);

        trainingData = sqlContext.read()
                .format("com.databricks.spark.csv")
                .option("header", "true")
                .load("transactions.csv")
                .repartition(6);
        trainingData.registerTempTable("RawTrainData");
        debug = sqlContext.sql("SELECT double(amount) label, category, weekofyear(date) weekOfYear, " +
                "date_format(date, 'EEEE') dayOfWeek FROM RawTrainData").na().drop();

    }

    public DataFrame getTrainingData() {
        return trainingData;
    }

    public void setTrainingData(DataFrame trainingData) {
        this.trainingData = trainingData;
    }

    public DataFrame getTestData() {
        return testData;
    }

    public void setTestData(DataFrame testData) {
        this.testData = testData;
    }
}
